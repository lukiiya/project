define(function(){!function(){for(var a=window.location.host,b={callbacks:{},send:function(a,b){this.dispatchMessage("event",a,b)},sendCallback:function(a){var b=d.createEnvelope(a);this.dispatchMessage("callback",b,function(){})},triggerCallback:function(a){var b=this;setTimeout(function(){b.callbacks[a]()},0)},dispatchMessage:function(a,b,c){var d=this;this.callbacks[b.id]=function(){c(),delete d.callbacks[b.id]};var e="jockey://"+a+"/"+b.id+"?"+encodeURIComponent(JSON.stringify(b)),f=document.createElement("iframe");f.setAttribute("src",e),document.documentElement.appendChild(f),f.parentNode.removeChild(f),f=null}},c={callbacks:{},send:function(a,b){this.dispatchMessage("jockeyEvent",a,b)},sendCallback:function(a){var b=d.createEnvelope(a);this.dispatchMessage("jockeyCallback",b,function(){})},triggerCallback:function(a){this.callbacks[a]&&this.callbacks[a]()},dispatchMessage:function(a,b,c){var e=this;this.callbacks[b.id]=function(){c(),delete e.callbacks[b.id]},d.targetWindow.postMessage({type:a,envelope:b},d.targetDomain)}},d={listeners:{},dispatchers:[],messageCount:0,targetDomain:"*",targetWindow:window.parent,on:function(a,b){(!this.listeners.hasOwnProperty(a)||!this.listeners[a]instanceof Array)&&(this.listeners[a]=[]),this.listeners[a].push(b)},off:function(a){(!this.listeners.hasOwnProperty(a)||!this.listeners[a]instanceof Array)&&(this.listeners[a]=[]),this.listeners[a]=[]},send:function(a,b,c){b instanceof Function&&(c=b,b=null),b=b||{},c=c||function(){};var d=this.createEnvelope(this.messageCount,a,b);this.dispatchers.forEach(function(a){a.send(d,c)}),this.messageCount+=1},trigger:function(a,b,c){for(var d=this,e=this.listeners[a]||[],f=0,g=function(){f+=1,f>=e.length&&d.dispatchers.forEach(function(a){a.sendCallback(b)})},h=0;h<e.length;h++){var i=e[h];i.length<=1?(i(c),g()):i(c,g)}},triggerCallback:function(a){this.dispatchers.forEach(function(b){b.triggerCallback(a)})},restrictIframeDispatcher:function(a,b){this.targetDomain=a,this.targetWindow=b},onMessageRecieved:function(a){if("*"==this.targetDomain||this.targetDomain==a.origin){var b=a.data.envelope;"jockeyEvent"==a.data.type?this.trigger(b.type,b.id,b.payload):"jockeyCallback"==a.data.type&&this.triggerCallback(a.data.envelope.id)}},createEnvelope:function(b,c,d){return{id:b,type:c,host:a,payload:d}}},e=0,f=!1,g=["iPad","iPhone","iPod"];e<g.length;e++)if(navigator.platform.indexOf(g[e])>=0){f=!0;break}var h=/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent),i=navigator.userAgent.toLowerCase().indexOf("android")>-1;(f&&h||i)&&d.dispatchers.push(b),d.dispatchers.push(c),window.addEventListener("message",$.proxy(d.onMessageRecieved,d),!1),window.Jockey=d}()});